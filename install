#!/usr/bin/env sh
help() {
    echo "Usage: ./install"
    echo "-h (print this message)"
}

while getopts ':p:w:d:g:h' opt; do
    case $opt in
        h)
            help
            exit
            ;;
        ?)
            echo "Invalid Parameter given. $(help)"
            ;;
    esac
done

os="$(uname)"

if [ "$os" = "Darwin" ]; then
    if ! [ -x "$(command -v brew)" ]; then
        echo "Installing homebrew"
        curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh
    fi

    if ! [ -x "$(command -v ansible-playbook)" ]; then
        echo "Install ansible"
        brew install ansible
    fi

    echo "Running mac ansible playbook"
    ansible-playbook --ask-become-pass \
                     -i hosts \
                     mac.yml

elif [ "$os" = "Linux" ]; then
    if ! [ -x "$(command -v ansible-playbook)" ]; then
        echo "Install ansible"
        sudo pacman -S ansible
    fi

    if ! [ -f "/etc/pam.d/sudo-nofp" ]; then
        echo "Set up sudo PAM module with no fingerprint auth"
        sudo cp pam/sudo-nofp /etc/pam.d/sudo-nofp
        sudo chown root:root /etc/pam.d/sudo-nofp
        sudo chmod 644 /etc/pam.d/sudo-nofp
    fi

    if ! [ -f "/etc/sudoers/20-root-ansible" ]; then
        echo "Set up root_ansible user and sudoers"
        sudo useradd root_ansible
        sudo cp sudoers/21-aur-ansible /etc/sudoers/21-aur-ansible
        sudo chown root:root /etc/sudoers/21-aur-ansible
        sudo chmod 440 /etc/sudoers/21-aur-ansible
    fi

    if ! [ -f "/etc/sudoers/21-aur-ansible" ]; then
        echo "Set up aur_ansible user and sudoers"
        sudo useradd aur_ansible
        sudo cp sudoers/21-aur-ansible /etc/sudoers/21-aur-ansible
        sudo chown root:root /etc/sudoers/21-aur-ansible
        sudo chmod 440 /etc/sudoers/21-aur-ansible
    fi

    echo "Install galaxy roles"
    ansible-galaxy install -r galaxy_requirements.yml

    echo "Running linux ansible playbook"
    ansible-playbook --ask-become-pass \
                     -i hosts \
                     linux.yml
else
   echo "Unknown OS: $os"
   exit 1
fi
